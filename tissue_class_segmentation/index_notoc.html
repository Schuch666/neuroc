<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title></title>

<link href="index_notoc_files/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="index_notoc_files/highlightjs-1.1/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>





</head>

<body>







<p>All code for this document is located at <a href="https://raw.githubusercontent.com/muschellij2/neuroc/master/tissue_class_segmentation/index.R">here</a>.</p>
<p>In this tutorial we will discuss performing tissue class segmentation using <code>atropos</code> in <code>ANTsR</code> and it’s wrapper function in <code>extrantsr</code>, <code>otropos</code>.</p>
<div id="data-packages" class="section level1">
<h1>Data Packages</h1>
<p>For this analysis, I will use one subject from the Kirby 21 data set. The <code>kirby21.base</code> and <code>kirby21.fmri</code> packages are necessary for this analysis and have the data we will be working on. You need devtools to install these. Please refer to <a href="neuroc-help-installing-devtools">installing devtools</a> for additional instructions or troubleshooting.</p>
<pre class="r"><code>packages = installed.packages()
packages = packages[, &quot;Package&quot;]
if (!&quot;kirby21.base&quot; %in% packages) {
  devtools::install_github(&quot;muschellij2/kirby21.base&quot;)
}
if (!&quot;kirby21.fmri&quot; %in% packages) {
  devtools::install_github(&quot;muschellij2/kirby21.fmri&quot;)
}</code></pre>
</div>
<div id="loading-data" class="section level1">
<h1>Loading Data</h1>
<p>We will use the <code>get_image_filenames_df</code> function to extract the filenames on our hard disk for the T1 image and the fMRI images (4D).</p>
<pre class="r"><code>library(kirby21.t1)
library(kirby21.base)
fnames = get_image_filenames_df(ids = 113, 
                    modalities = c(&quot;T1&quot;), 
                    visits = c(1),
                    long = FALSE)
t1_fname = fnames$T1[1]</code></pre>
</div>
<div id="using-information-from-the-t1-image" class="section level1">
<h1>Using information from the T1 image</h1>
<div id="brain-extracted-image" class="section level2">
<h2>Brain extracted image</h2>
<p>Please visit the <a href="neuroc-help-brain-extraction">brain extraction tutorial</a> on how to extract a brain from this image. We will use the output from <code>fslbet_robust</code> from that tutorial.</p>
<pre class="r"><code>outfile = nii.stub(t1_fname, bn = TRUE)
outfile = file.path(&quot;..&quot;, &quot;brain_extraction&quot;, outfile)
outfile = paste0(outfile, &quot;_SS.nii.gz&quot;)
ss = readnii(outfile)
ss_red = dropEmptyImageDimensions(ss)
ortho2(ss_red)</code></pre>
<p><img src="index_files/figure-html/t1_ss-1.png" /><!-- --></p>
<p>Again, we can see the zoomed-in view of the image now.</p>
</div>
<div id="tissue-class-segmentation-with-atropos" class="section level2">
<h2>Tissue-Class Segmentation with Atropos</h2>
<pre class="r"><code>outfile = nii.stub(t1_fname, bn = TRUE)
prob_files = paste0(outfile,
                    &quot;_prob_&quot;, 1:3,
                    &quot;.nii.gz&quot;)
seg_outfile = paste0(outfile, &quot;_Seg.nii.gz&quot;)

if (!all(file.exists(
  c(seg_outfile, prob_files)
  ))) {
  seg = extrantsr::otropos(
    ss_red, 
    x = ss_red &gt; 0,
    v = 1)
  hard_seg = seg$segmentation
  writenii(hard_seg, seg_outfile)
  for (i in seq_along(seg$probabilityimages)) {
    writenii(seg$probabilityimages[[i]], prob_files[i]) 
  }
  # writenii(seg, )
} else {
  hard_seg = readnii(seg_outfile)
  seg = vector(mode = &quot;list&quot;, length = 2)
  names(seg) = c(&quot;segmentation&quot;, &quot;probabilityimages&quot;)
  seg$segmentation = hard_seg
  seg$probabilityimages = vector(mode = &quot;list&quot;, length = 3)
  for (i in 1:3) {
    seg$probabilityimages[[i]] = readnii(prob_files[i]) 
  }  
}</code></pre>
<div id="atropos-results" class="section level3">
<h3>Atropos results</h3>
<p>Now we have a hard segmentation, which assigns a class with the maximum probability to that voxel. We also have a separate probability image for each tissue class.</p>
<pre class="r"><code>double_ortho(ss_red, hard_seg)</code></pre>
<p><img src="index_files/figure-html/t1_seg_plot-1.png" /><!-- --></p>
<p>We see that much of the structures have been segmented well, but there may be errors.</p>
</div>
<div id="atropos-intensity-histograms" class="section level3">
<h3>Atropos intensity histograms</h3>
<p>We can also look at the distribution of intensities (marginally) for each tissue class. In <code>atropos</code>, the classes are ordered by mean intensity, so we can re-assign them to the corresponding tissue class</p>
<pre class="r"><code>df = data.frame(value = ss_red[ss_red &gt; 0],
                class = hard_seg[ss_red &gt; 0])
df$class = c(&quot;CSF&quot;, &quot;GM&quot;, &quot;WM&quot;)[df$class]
ggplot(df, aes(x = value, colour = factor(class))) + geom_line(stat = &quot;density&quot;)</code></pre>
<p><img src="index_files/figure-html/t1_val_plot-1.png" /><!-- --></p>
<pre class="r"><code>rm(list = &quot;df&quot;)</code></pre>
</div>
</div>
<div id="tissue-class-segmentation-with-fast" class="section level2">
<h2>Tissue-Class Segmentation with FAST</h2>
<pre class="r"><code>library(fslr)
outfile = nii.stub(t1_fname, bn = TRUE)
outfile = paste0(outfile, &quot;_FAST&quot;)
prob_files = paste0(outfile,
                    &quot;_pve_&quot;, 0:2,
                    &quot;.nii.gz&quot;)
seg_outfile = paste0(outfile, &quot;_Seg.nii.gz&quot;)

if (!all(file.exists(
  c(seg_outfile, prob_files)
  ))) {
  fast_hard_seg = fast(file = ss_red, 
                   outfile = outfile, 
                   out_type = &quot;seg&quot;,
                   opts = &quot;--nobias&quot;)
  writenii(fast_hard_seg, seg_outfile)
} else {
  fast_hard_seg = readnii(seg_outfile)
}
fast_seg = vector(mode = &quot;list&quot;, length = 3)
for (i in 1:3) {
  fast_seg[[i]] = readnii(prob_files[i]) 
}  </code></pre>
<div id="fast-results" class="section level3">
<h3>FAST results</h3>
<p>Let’s see the results of the FAST segmentation:</p>
<pre class="r"><code>double_ortho(ss_red, hard_seg)</code></pre>
<p><img src="index_files/figure-html/fast_seg_plot-1.png" /><!-- --></p>
</div>
<div id="fast-intensity-histograms" class="section level3">
<h3>FAST intensity histograms</h3>
<p>Again, we can look at the distribution of values, ad now we can compare distributions of the values from FAST to that of atropos.</p>
<pre class="r"><code>df = data.frame(value = ss_red[ss_red &gt; 0],
                fast = fast_hard_seg[ss_red &gt; 0],
                atropos = hard_seg[ss_red &gt; 0],
                ind = which(ss_red &gt; 0)
                )
df = reshape2::melt(df, id.vars = c(&quot;ind&quot;, &quot;value&quot;), 
                    measure.vars = c(&quot;fast&quot;, &quot;atropos&quot;),
                    value.name = &quot;class&quot;,
                    variable.name = &quot;segmentation&quot;)
df = df %&gt;% arrange(ind)</code></pre>
<pre><code>Warning: failed to assign NativeSymbolInfo for env since env is already
defined in the &#39;lazyeval&#39; namespace</code></pre>
<pre class="r"><code>df$ind = NULL

df$class = c(&quot;CSF&quot;, &quot;GM&quot;, &quot;WM&quot;)[df$class]
ggplot(df, aes(x = value, colour = factor(class))) + 
  geom_line(stat = &quot;density&quot;) + 
  xlim(c(0, 1e6)) +
  facet_wrap(~ segmentation, ncol = 1)</code></pre>
<pre><code>Warning: Removed 596 rows containing non-finite values (stat_density).</code></pre>
<p><img src="index_files/figure-html/fast_val_plot-1.png" /><!-- --></p>
<pre class="r"><code>rm(list = &quot;df&quot;)</code></pre>
</div>
</div>
<div id="tissue-class-segmentation-with-spm" class="section level2">
<h2>Tissue-Class Segmentation with SPM</h2>
<p>In the <a href="neuroc-help-brain-extraction">brain extraction tutorial</a> we discuss the SPM segmenation procedures and show how to use them to produce hard segmentations, probability maps, and a brain extracted image. We will use the results of that tutorial to compare to that of <code>atropos</code>. We will exclude any tissues outside of GM, WM, and CSF (those &gt; 3).</p>
<pre class="r"><code>outfile = nii.stub(t1_fname, bn = TRUE)
outfile = file.path(&quot;..&quot;, &quot;brain_extraction&quot;, outfile)
outfile = paste0(outfile, &quot;_SPM_Seg.nii.gz&quot;)
spm_hard_seg = readnii(outfile)
spm_hard_seg[ spm_hard_seg &gt; 3] = 0
dd = dropEmptyImageDimensions(
  ss,
  other.imgs = spm_hard_seg)
spm_hard_seg_red = dd$other.imgs</code></pre>
<div id="spm-results" class="section level3">
<h3>SPM results</h3>
<pre class="r"><code>double_ortho(ss_red, spm_hard_seg_red)</code></pre>
<p><img src="index_files/figure-html/t1_spm_seg_plot-1.png" /><!-- --></p>
<p>Remember however, in the SPM segmentation, 1 is GM, 2 is WM, 3 is CSF, and in Atropos/FAST, 1 is CSF, 2 is GM, 3 is WM, .</p>
<pre class="r"><code>spm_recode = niftiarr(spm_hard_seg_red, 0)
spm_recode[ spm_hard_seg_red %in% 1 ] = 2
spm_recode[ spm_hard_seg_red %in% 2 ] = 3
spm_recode[ spm_hard_seg_red %in% 3 ] = 1</code></pre>
<pre class="r"><code>double_ortho(ss_red, spm_recode)</code></pre>
<p><img src="index_files/figure-html/t1_spm_recode_seg_plot-1.png" /><!-- --></p>
<pre class="r"><code>df = data.frame(spm = spm_recode[spm_recode &gt; 0 | hard_seg &gt; 0],
                atropos = hard_seg[spm_recode &gt; 0 | hard_seg &gt; 0],
                value = ss_red[spm_recode &gt; 0 | hard_seg &gt; 0])
df$spm = c(&quot;Background&quot;, &quot;CSF&quot;, &quot;GM&quot;, &quot;WM&quot;)[df$spm + 1]
df$atropos = c(&quot;Background&quot;, &quot;CSF&quot;, &quot;GM&quot;, &quot;WM&quot;)[df$atropos + 1]
df$spm = factor(df$spm, levels = c(&quot;Background&quot;, &quot;CSF&quot;, &quot;GM&quot;, &quot;WM&quot;))
df$atropos = factor(df$atropos, levels = c(&quot;Background&quot;, &quot;CSF&quot;, &quot;GM&quot;, &quot;WM&quot;))
tab = with(df, table(spm, atropos))
print(tab)</code></pre>
<pre><code>            atropos
spm          Background    CSF     GM     WM
  Background          0  27972   1053    756
  CSF             50255 102999   7146      0
  GM              23839  66622 450565  60141
  WM                455      0    946 339557</code></pre>
<p>We can also compare the 2 segmentations. Here, if we assume the SPM segmentation as the “gold standard” and the Atropos one as another “prediction”, we can look at the differences. Anywhere they both agree (both are a 1) it will be deemed a true positive and will be in green. Anywhere the Atropos segmentation includes a voxel but the SPM segmentation did not, it will deemed a false positive and will be in blue, vice versa in red will be a false negative.</p>
<pre class="r"><code>compare = spm_recode == hard_seg
compare[ (spm_recode &gt; 0 | hard_seg &gt; 0) &amp; !compare ] = 2
compare[ spm_recode == 0 &amp; hard_seg == 0  ] = 0</code></pre>
<pre class="r"><code>ortho2(ss_red, compare, col.y = alpha(c(&quot;blue&quot;, &quot;red&quot;), 0.5))</code></pre>
<p><img src="index_files/figure-html/t1_compare_seg_plot-1.png" /><!-- --></p>
<pre class="r"><code>double_ortho(ss_red, compare, col.y = alpha(c(&quot;blue&quot;, &quot;red&quot;), 0.5))</code></pre>
<p><img src="index_files/figure-html/t1_compare_seg_plot-2.png" /><!-- --></p>
<pre class="r"><code>x = list(ss_red,
             ss_red)
y = list(spm = spm_recode,
         atropos = hard_seg)
z = floor(nsli(ss_red)/2)
multi_overlay(x, y, z = z, col.y = alpha(hotmetal(), 0.25))</code></pre>
<p><img src="index_files/figure-html/compare_multi-1.png" /><!-- --></p>
</div>
<div id="spm-intensity-histograms" class="section level3">
<h3>SPM intensity histograms</h3>
<p>Although there may be places in the brain where SPM calls a class CSF, WM, or GM where the brain mask is zero, we will exclude these in the comparison to fast and atropos for a common comparison. We will make sure that if voxels within the brain mask are labeled as zero in the SPM segmentation, we will denote these as <code>Background</code>.</p>
<pre class="r"><code>df = data.frame(value = ss_red[ss_red &gt; 0],
                fast = fast_hard_seg[ss_red &gt; 0],
                atropos = hard_seg[ss_red &gt; 0],
                spm = spm_recode[ss_red &gt; 0],
                ind = which(ss_red &gt; 0)
                )
df = reshape2::melt(df, id.vars = c(&quot;ind&quot;, &quot;value&quot;), 
                    measure.vars = c(&quot;fast&quot;, &quot;atropos&quot;, &quot;spm&quot;),
                    value.name = &quot;class&quot;,
                    variable.name = &quot;segmentation&quot;)
df = df %&gt;% arrange(ind)
df$ind = NULL

df$class = c(&quot;Background&quot;, &quot;CSF&quot;, &quot;GM&quot;, &quot;WM&quot;)[df$class + 1]
ggplot(df, aes(x = value, colour = factor(class))) + 
  geom_line(stat = &quot;density&quot;) + 
  xlim(c(0, 1e6)) +
  facet_wrap(~ segmentation, ncol = 1)</code></pre>
<pre><code>Warning: Removed 894 rows containing non-finite values (stat_density).</code></pre>
<p><img src="index_files/figure-html/spm_val_plot-1.png" /><!-- --></p>
<pre class="r"><code>rm(list = &quot;df&quot;)</code></pre>
</div>
</div>
<div id="discussion" class="section level2">
<h2>Discussion</h2>
<p>Note, <code>atropos</code> and <code>fast</code> generally require a skull-stripped image. Many skull-stripping algorithms remove the extra-cortical areas of the brain but inside the skull, which generally are CSF spaces with meninges. These CSF spaces are dropped after skull-stripping/brain extraction. If we are trying to consistently measure the CSF or “whole brain volume” (if that includes CSF spaces), this may cause issues. The SPM segmentation usually includes more CSF spaces, but we have shown in the <a href="neuroc-help-brain-extraction">brain extraction tutorial</a> that there are areas that BET denotes as brain and SPM does not on the surface.</p>
</div>
</div>
<div id="session-info" class="section level1">
<h1>Session Info</h1>
<pre class="r"><code>devtools::session_info()</code></pre>
<pre><code>Session info -------------------------------------------------------------</code></pre>
<pre><code> setting  value                       
 version  R version 3.3.1 (2016-06-21)
 system   x86_64, darwin13.4.0        
 ui       X11                         
 language (EN)                        
 collate  en_US.UTF-8                 
 tz       America/New_York            
 date     2016-12-21                  </code></pre>
<pre><code>Packages -----------------------------------------------------------------</code></pre>
<pre><code> package      * version     date       source                             
 abind          1.4-5       2016-07-21 cran (@1.4-5)                      
 animation    * 2.4         2015-08-16 CRAN (R 3.2.0)                     
 ANTsR        * 0.3.3       2016-11-17 Github (stnava/ANTsR@063700b)      
 assertthat     0.1         2013-12-06 CRAN (R 3.2.0)                     
 backports      1.0.4       2016-10-24 CRAN (R 3.3.0)                     
 bitops         1.0-6       2013-08-17 CRAN (R 3.2.0)                     
 colorout     * 1.1-0       2015-04-20 Github (jalvesaq/colorout@1539f1f) 
 colorspace     1.3-0       2016-11-10 CRAN (R 3.3.2)                     
 DBI            0.5-1       2016-09-10 CRAN (R 3.3.0)                     
 devtools       1.12.0.9000 2016-12-08 Github (hadley/devtools@1ce84b0)   
 digest         0.6.10      2016-08-02 cran (@0.6.10)                     
 dplyr        * 0.5.0       2016-06-24 CRAN (R 3.3.0)                     
 evaluate       0.10        2016-10-11 CRAN (R 3.3.0)                     
 fslr         * 2.5.1       2016-12-21 Github (muschellij2/fslr@5e46b66)  
 ggplot2      * 2.2.0       2016-11-11 CRAN (R 3.3.2)                     
 gtable         0.2.0       2016-02-26 CRAN (R 3.2.3)                     
 htmltools      0.3.6       2016-12-08 Github (rstudio/htmltools@4fbf990) 
 kirby21.base * 1.4.2       2016-10-05 local                              
 kirby21.fmri * 1.4         2016-09-29 local (@1.4)                       
 knitr          1.15.1      2016-11-22 cran (@1.15.1)                     
 lattice        0.20-34     2016-09-06 CRAN (R 3.3.0)                     
 lazyeval       0.2.0       2016-06-12 CRAN (R 3.3.0)                     
 magrittr       1.5         2014-11-22 CRAN (R 3.2.0)                     
 matrixStats  * 0.51.0      2016-10-09 cran (@0.51.0)                     
 memoise        1.0.0       2016-01-29 CRAN (R 3.2.3)                     
 munsell        0.4.3       2016-02-13 CRAN (R 3.2.3)                     
 neurobase    * 1.9.1       2016-12-21 local                              
 oro.nifti    * 0.7.2       2016-12-21 Github (bjw34032/oro.nifti@a713047)
 pkgbuild       0.0.0.9000  2016-12-08 Github (r-pkgs/pkgbuild@65eace0)   
 pkgload        0.0.0.9000  2016-12-08 Github (r-pkgs/pkgload@def2b10)    
 plyr           1.8.4       2016-06-08 CRAN (R 3.3.0)                     
 R.methodsS3  * 1.7.1       2016-02-16 CRAN (R 3.2.3)                     
 R.oo         * 1.21.0      2016-11-01 cran (@1.21.0)                     
 R.utils      * 2.5.0       2016-11-07 cran (@2.5.0)                      
 R6             2.2.0       2016-10-05 cran (@2.2.0)                      
 RColorBrewer * 1.1-2       2014-12-07 CRAN (R 3.2.0)                     
 Rcpp           0.12.8.2    2016-12-08 Github (RcppCore/Rcpp@8c7246e)     
 reshape2     * 1.4.2       2016-10-22 CRAN (R 3.3.0)                     
 rmarkdown      1.2.9000    2016-12-08 Github (rstudio/rmarkdown@7a3df75) 
 RNifti         0.3.0       2016-12-08 cran (@0.3.0)                      
 rprojroot      1.1         2016-10-29 cran (@1.1)                        
 scales         0.4.1       2016-11-09 CRAN (R 3.3.2)                     
 stringi        1.1.2       2016-10-01 CRAN (R 3.3.0)                     
 stringr        1.1.0       2016-08-19 cran (@1.1.0)                      
 tibble         1.2         2016-08-26 CRAN (R 3.3.0)                     
 withr          1.0.2       2016-06-20 CRAN (R 3.3.0)                     
 yaml           2.1.14      2016-11-12 CRAN (R 3.3.2)                     
 zoo          * 1.7-13      2016-05-03 CRAN (R 3.2.4)                     </code></pre>
</div>
<div id="references" class="section level1">
<h1>References</h1>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
