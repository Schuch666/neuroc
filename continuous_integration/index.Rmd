---
title: "Continuous Integration and Testing"
author: "John Muschelli"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: true
    theme: cosmo
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
    number_sections: true      
bibliography: ../refs.bib      
---

```{r setup, include=FALSE}
library(devtools)
```

All code for this document is located at [here](https://raw.githubusercontent.com/muschellij2/neuroc/master/continuous_integration/index.R).

# Changes to the `DESCRIPTION` file
In order to test packages against the relevant Neuroconductor packages, we change the `DESCRIPTION` file.  We do this in the following ways:

1. Modify, or add if not present, the `Remotes` field. Packages are installed using the `install_github` function, which reads this `Remotes` field to install dependencies if necessary. The Remotes field modifies and overrides the locations of dependencies to be installed. If a dependency for a package is present, then a newer version of the package will not be installed unless indicated by the user or indicated a newer version is necessary in the package (by the package (`>= VERSION`)) syntax) in the dependencies.
2. We add the `bioViews` field to a package in case there are Bioconductor package in the dependencies, to ensure `install_github` looks in that repository, as per the issue [hadley/devtools#1254](https://github.com/hadley/devtools/issues/1254).


# Continuous Integration Services

For checking R packages, we use [Continuous Integration](https://en.wikipedia.org/wiki/Continuous_integration) services [Travis CI](https://travis-ci.org/), which builds on Linux and OS X operating systems, and [Appveyor](https://www.appveyor.com/), which builds on Windows using MinGW.  

The purpose is to ensure that the package can be built, installed, and checked on the respective systems with the appropriate dependencies.  

## Travis CI
For Travis CI, we build an initial `.travis.yml` configuration script using `devtools::use_travis()`.   This adds the following to the `.travis.yml`:

```
# R for travis: see documentation at https://docs.travis-ci.com/user/languages/r

language: R
sudo: false
cache: packages
```

We add the following fields to the YAML:

1.  To ensure Bioconductor packages can be installed if necessary:

```
bioc_required: yes
use_bioc: yes
```

2.  So that we ensure that no warnings are present in the installation (similar to CRAN):
```
warnings_are_errors: true
```

3.  That we have a similar threshold for packages similar to CRAN:

```
r_check_args: --as-cran
```

### Future work
In the future, we plan on submitting tagged commits for releases.  We will have built binaries and sources for each version of the package that is submittted.  We also plan to add Neuroconductor badges to the `README.md` file.  


## Appveyor 

Currently, we only support packages that work in *nix type of operatings systems.  We will check the package for Windows as a courtesy to Windows users, but do not provide a detailed level of support.  Moreover, we do not currently support or change appveyor builds to pass for developers.  

For checking, similar to Travis, we use `devtools::use_appveyor()` to generate the `appveyor.yml`, which adds the following:

```

# Download script file from GitHub
init:
  ps: |
        $ErrorActionPreference = "Stop"
        Invoke-WebRequest http://raw.github.com/krlmlr/r-appveyor/master/scripts/appveyor-tool.ps1 -OutFile "..\appveyor-tool.ps1"
        Import-Module '..\appveyor-tool.ps1'

install:
  ps: Bootstrap

cache:
  - C:\RLibrary

# Adapt as necessary starting from here

build_script:
  - travis-tool.sh install_deps

test_script:
  - travis-tool.sh run_tests

on_failure:
  - 7z a failure.zip *.Rcheck\*
  - appveyor PushArtifact failure.zip

artifacts:
  - path: '*.Rcheck\**\*.log'
    name: Logs

  - path: '*.Rcheck\**\*.out'
    name: Logs

  - path: '*.Rcheck\**\*.fail'
    name: Logs

  - path: '*.Rcheck\**\*.Rout'
    name: Logs

  - path: '\*_*.tar.gz'
    name: Bits

  - path: '\*_*.zip'
    name: Bits
```

# Code Coverage

## Coveralls 
We plan to use the [`covr`](https://github.com/jimhester/covr) package to check for code coverage using the [Coveralls](https://coveralls.io/) interface.  We currently do not have any requirements for code coverage for our packages.

# Session Info

```{r}
devtools::session_info()
```
