<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title></title>







</head>

<body>







<p>All code for this document is located at <a href="https://raw.githubusercontent.com/muschellij2/neuroc/master/DTI_analysis_fslr/index.R">here</a>.</p>
<div id="resources-and-goals" class="section level1">
<h1>Resources and Goals</h1>
<p>Much of this work has been adapted by the FSL guide for DTI: <a href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FDT/UserGuide" class="uri">http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FDT/UserGuide</a>. We will show you a few steps that have been implemented in <code>fslr</code>: <code>eddy_correct</code> and <code>dtifit</code>. Although <code>xfibres</code> has been adapted for <code>fslr</code>, which is the backend for <code>bedpostx</code> from FSL, it takes a long time to run and the results are not seen in this vignette, though code is given to illustrate how it would be run.</p>
</div>
<div id="data-packages" class="section level1">
<h1>Data Packages</h1>
<p>For this analysis, I will use one subject from the Kirby 21 data set. The <code>kirby21.base</code> and <code>kirby21.dti</code> packages are necessary for this analysis and have the data we will be working on. You need devtools to install these. Please refer to <a href="neuroc-help-installing-devtools">installing devtools</a> for additional instructions or troubleshooting.</p>
<pre class="r"><code>packages = installed.packages()
packages = packages[, &quot;Package&quot;]
if (!&quot;kirby21.base&quot; %in% packages) {
  devtools::install_github(&quot;muschellij2/kirby21.base&quot;)
}
if (!&quot;kirby21.dti&quot; %in% packages) {
  devtools::install_github(&quot;muschellij2/kirby21.dti&quot;)
}</code></pre>
</div>
<div id="loading-data" class="section level1">
<h1>Loading Data</h1>
<p>We will use the <code>get_image_filenames_df</code> function to extract the filenames on our hard disk for the T1 image.</p>
<pre class="r"><code>library(kirby21.dti)
library(kirby21.base)
fnames = get_image_filenames_df(ids = 113, 
                    modalities = c(&quot;T1&quot;, &quot;DTI&quot;), 
                    visits = c(1),
                    long = FALSE)
t1_fname = fnames$T1[1]
dti_fname = fnames$DTI[1]
base_fname = nii.stub(dti_fname, bn = TRUE)
dti_data = get_dti_info_filenames(
  ids = 113, 
  visits = c(1))
b_fname = dti_data$fname[ dti_data$type %in% &quot;b&quot;]
grad_fname = dti_data$fname[ dti_data$type %in% &quot;grad&quot;]</code></pre>
<div id="making-b-vectors-and-b-values" class="section level2">
<h2>Making b-vectors and b-values</h2>
<p>As <code>dtifit</code> requires the b-values and b-vectors to be separated, we will take a look at this data.</p>
<pre class="r"><code>b_vals = readLines(b_fname)
b_vals = as.numeric(b_vals)
b0 = which(b_vals == 0)[1]

b_vecs = read.delim(grad_fname, header = FALSE)
stopifnot(all(is.na(b_vecs$V4)))
b_vecs$V4 = NULL
colnames(b_vecs) = c(&quot;x&quot;, &quot;y&quot;, &quot;z&quot;)</code></pre>
</div>
<div id="printing-out-fsl-version" class="section level2">
<h2>Printing out FSL Version</h2>
<pre class="r"><code>library(fslr)
print(fsl_version())</code></pre>
<pre><code>## [1] &quot;5.0.0&quot;</code></pre>
</div>
<div id="checking-our-data" class="section level2">
<h2>Checking our data</h2>
<p>Here we ensure that the number of b-values/b-vectors is the same as the number of time points in the 4D image.</p>
<pre class="r"><code>n_timepoints = fslval(dti_fname, &quot;dim4&quot;)</code></pre>
<pre><code>## fslval &quot;/Library/Frameworks/R.framework/Versions/3.3/Resources/library/kirby21.dti/visit_1/113/113-01-DTI.nii.gz&quot; dim4</code></pre>
<pre class="r"><code>stopifnot(nrow(b_vecs) == n_timepoints)
stopifnot(length(b_vals) == n_timepoints)</code></pre>
</div>
</div>
<div id="running-eddy_correct" class="section level1">
<h1>Running <code>eddy_correct</code></h1>
<p>Here, we will run an eddy current correction using FSL’s <code>eddy_correct</code> through <code>fslr</code>. We will save the result in a temporary file (<code>outfile</code>), but also return the result as a <code>nifti</code> object <code>ret</code>, as <code>retimg = TRUE</code>. We will use the first volume as the reference as is the default in FSL. <em>Note</em> FSL is zero-indexed so the first volume is the zero-ith index:</p>
<pre class="r"><code>eddy_fname = paste0(base_fname, &quot;_eddy.nii.gz&quot;)
if (!file.exists(eddy_fname)) {
  eddy = eddy_correct(
    infile = dti_fname, 
    outfile = eddy_fname, 
    retimg = TRUE, 
    reference_no = 0)
} else {
  eddy = readnii(eddy_fname)
}</code></pre>
<p>Let’s look at the eddy current-corrected (left) and the non-corrected data (right). Here we will look at the image where the b-value is equal to zero.</p>
<pre class="r"><code>dti = readnii(dti_fname)
eddy0 = extrantsr::subset_4d(eddy, b0)
dti0 = extrantsr::subset_4d(dti, b0)</code></pre>
<pre class="r"><code>double_ortho(robust_window(eddy0), robust_window(dti0))</code></pre>
<p><img src="index_files/figure-html/eddy0_plot-1.png" /><!-- --></p>
<p>Note, from here on forward we will use either the filename for the output of the eddy current correction or the eddy-current-corrected <code>nifti</code> object.</p>
</div>
<div id="getting-a-brain-mask" class="section level1">
<h1>Getting a brain mask</h1>
<p>Let’s get a brain mask from the eddy-corrected data:</p>
<pre class="r"><code>mask_fname = paste0(base_fname, &quot;_mask.nii.gz&quot;)
if (!file.exists(mask_fname)) {
  fsl_bet(infile = dti0, outfile = mask_fname)
} 
mask = readnii(mask_fname)</code></pre>
<pre class="r"><code>ortho2(robust_window(dti0), mask, col.y = alpha(&quot;red&quot;, 0.5))</code></pre>
<p><img src="index_files/figure-html/bet_plot-1.png" /><!-- --></p>
</div>
<div id="running-dti-fitting-as-a-cursor" class="section level1">
<h1>Running DTI Fitting as a cursor</h1>
<p>Now that we have eddy current corrected our data, we can pass that result into <code>dtifit</code> to get FA maps and such:</p>
<pre class="r"><code>outprefix = base_fname
suffixes = c(paste0(&quot;V&quot;, 1:3),
             paste0(&quot;L&quot;, 1:3),
             &quot;MD&quot;, &quot;FA&quot;, &quot;MO&quot;, &quot;S0&quot;)
outfiles = paste0(outprefix, &quot;_&quot;, 
                  suffixes, get.imgext())
names(outfiles) = suffixes
if (!all(file.exists(outfiles))) {
  res = dtifit(infile = eddy_fname, 
               bvecs = as.matrix(b_vecs),
               bvals = b_vals, 
               mask = mask_fname,
               outprefix = outprefix)
}</code></pre>
<p>By default, the result of <code>dtifit</code> is the filenames of the resultant images. Here we will read in those images:</p>
<pre class="r"><code>res_imgs = lapply(outfiles[c(&quot;FA&quot;, &quot;MD&quot;)], readnii)</code></pre>
<div id="plotting-an-fa-map" class="section level2">
<h2>Plotting an FA map</h2>
<p>Using the <code>ortho2</code> function, you can plot the fractional anisotropy (FA) map</p>
<pre class="r"><code>ortho2(res_imgs$FA)</code></pre>
<p><img src="index_files/figure-html/plot_fa-1.png" /><!-- --></p>
<p>and the mean diffusivity (MD) map:</p>
<pre class="r"><code>ortho2(res_imgs$MD)</code></pre>
<p><img src="index_files/figure-html/plot_md-1.png" /><!-- --></p>
<p>or both at the same time using the <code>double_ortho</code> function:</p>
<pre class="r"><code>double_ortho(res_imgs$FA, res_imgs$MD)</code></pre>
<p><img src="index_files/figure-html/plot_fa_md-1.png" /><!-- --></p>
<p>You can look at a scatterplot of the FA vs MD values of all values inside the mask using the following code:</p>
<pre class="r"><code>mask = readnii(mask_fname)
df = data.frame(FA = res_imgs$FA[ mask == 1], 
                MD = res_imgs$MD[ mask == 1] )
ggplot(df, aes(x = FA, y = MD)) + stat_binhex()</code></pre>
<p><img src="index_files/figure-html/make_hex-1.png" /><!-- --></p>
<pre class="r"><code>rm(list = &quot;df&quot;)
rm(list = &quot;mask&quot;)</code></pre>
</div>
</div>
<div id="fitting-bedpostx" class="section level1">
<h1>Fitting bedpostx</h1>
<p>Accoriding to <a href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FDT/UserGuide" class="uri">http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FDT/UserGuide</a>, the <code>bedpostx</code> function from FSL stands for “Bayesian Estimation of Diffusion Parameters Obtained using Sampling Techniques. The X stands for modelling Crossing Fibres”. It also states “bedpostx takes about 15 hours to run”. We have implemented <code>xfibres</code>, the function <code>bedpostx</code> calls. Running it with the default options, the command would be:</p>
<pre class="r"><code>xfibres(infile = outfile, 
        bvecs = b_vecs,
        bvals = b_vals,
        mask = mask_fname)</code></pre>
<p>We are currently implementing <code>probtracx2</code> and an overall wrapper for all these functions to work as a pipeline.</p>
</div>
<div id="session-info" class="section level1">
<h1>Session Info</h1>
<pre class="r"><code>devtools::session_info()</code></pre>
<pre><code>## Session info -------------------------------------------------------------</code></pre>
<pre><code>##  setting  value                       
##  version  R version 3.3.1 (2016-06-21)
##  system   x86_64, darwin13.4.0        
##  ui       X11                         
##  language (EN)                        
##  collate  en_US.UTF-8                 
##  tz       America/New_York            
##  date     2016-12-21</code></pre>
<pre><code>## Packages -----------------------------------------------------------------</code></pre>
<pre><code>##  package      * version     date       source                             
##  abind          1.4-5       2016-07-21 cran (@1.4-5)                      
##  ANTsR        * 0.3.3       2016-11-17 Github (stnava/ANTsR@063700b)      
##  assertthat     0.1         2013-12-06 CRAN (R 3.2.0)                     
##  backports      1.0.4       2016-10-24 CRAN (R 3.3.0)                     
##  bitops         1.0-6       2013-08-17 CRAN (R 3.2.0)                     
##  colorout     * 1.1-0       2015-04-20 Github (jalvesaq/colorout@1539f1f) 
##  colorspace     1.3-0       2016-11-10 CRAN (R 3.3.2)                     
##  DBI            0.5-1       2016-09-10 CRAN (R 3.3.0)                     
##  devtools       1.12.0.9000 2016-12-08 Github (hadley/devtools@1ce84b0)   
##  digest         0.6.10      2016-08-02 cran (@0.6.10)                     
##  dplyr        * 0.5.0       2016-06-24 CRAN (R 3.3.0)                     
##  evaluate       0.10        2016-10-11 CRAN (R 3.3.0)                     
##  EveTemplate  * 0.99.14     2016-09-15 local                              
##  extrantsr    * 2.8         2016-11-20 local                              
##  fslr         * 2.5.1       2016-12-21 Github (muschellij2/fslr@5e46b66)  
##  ggplot2      * 2.2.0       2016-11-11 CRAN (R 3.3.2)                     
##  gtable         0.2.0       2016-02-26 CRAN (R 3.2.3)                     
##  hash           2.2.6       2013-02-21 CRAN (R 3.2.0)                     
##  htmltools      0.3.6       2016-12-08 Github (rstudio/htmltools@4fbf990) 
##  igraph         1.0.1       2015-06-26 CRAN (R 3.2.0)                     
##  iterators      1.0.8       2015-10-13 CRAN (R 3.2.0)                     
##  kirby21.base * 1.4.2       2016-10-05 local                              
##  kirby21.dti  * 1.4.1       2016-10-07 local                              
##  knitr        * 1.15.1      2016-11-22 cran (@1.15.1)                     
##  lattice        0.20-34     2016-09-06 CRAN (R 3.3.0)                     
##  lazyeval       0.2.0       2016-06-12 CRAN (R 3.3.0)                     
##  magrittr       1.5         2014-11-22 CRAN (R 3.2.0)                     
##  Matrix         1.2-7.1     2016-09-01 CRAN (R 3.3.0)                     
##  matrixStats    0.51.0      2016-10-09 cran (@0.51.0)                     
##  memoise        1.0.0       2016-01-29 CRAN (R 3.2.3)                     
##  mgcv           1.8-16      2016-11-07 CRAN (R 3.3.0)                     
##  mmap           0.6-12      2013-08-28 CRAN (R 3.3.0)                     
##  munsell        0.4.3       2016-02-13 CRAN (R 3.2.3)                     
##  neurobase    * 1.9.1       2016-12-21 local                              
##  neuroim        0.1.0       2016-09-27 local                              
##  nlme           3.1-128     2016-05-10 CRAN (R 3.3.1)                     
##  oro.nifti    * 0.7.2       2016-12-21 Github (bjw34032/oro.nifti@a713047)
##  pkgbuild       0.0.0.9000  2016-12-08 Github (r-pkgs/pkgbuild@65eace0)   
##  pkgload        0.0.0.9000  2016-12-08 Github (r-pkgs/pkgload@def2b10)    
##  plyr         * 1.8.4       2016-06-08 CRAN (R 3.3.0)                     
##  R.matlab       3.6.1       2016-10-20 CRAN (R 3.3.0)                     
##  R.methodsS3    1.7.1       2016-02-16 CRAN (R 3.2.3)                     
##  R.oo           1.21.0      2016-11-01 cran (@1.21.0)                     
##  R.utils        2.5.0       2016-11-07 cran (@2.5.0)                      
##  R6             2.2.0       2016-10-05 cran (@2.2.0)                      
##  Rcpp           0.12.8.2    2016-12-08 Github (RcppCore/Rcpp@8c7246e)     
##  reshape2     * 1.4.2       2016-10-22 CRAN (R 3.3.0)                     
##  rmarkdown      1.2.9000    2016-12-08 Github (rstudio/rmarkdown@7a3df75) 
##  RNifti         0.3.0       2016-12-08 cran (@0.3.0)                      
##  rprojroot      1.1         2016-10-29 cran (@1.1)                        
##  scales         0.4.1       2016-11-09 CRAN (R 3.3.2)                     
##  stringi        1.1.2       2016-10-01 CRAN (R 3.3.0)                     
##  stringr        1.1.0       2016-08-19 cran (@1.1.0)                      
##  tibble         1.2         2016-08-26 CRAN (R 3.3.0)                     
##  WhiteStripe    2.0.1       2016-12-02 local                              
##  withr          1.0.2       2016-06-20 CRAN (R 3.3.0)                     
##  yaImpute       1.0-26      2015-07-20 CRAN (R 3.2.0)                     
##  yaml           2.1.14      2016-11-12 CRAN (R 3.3.2)</code></pre>
</div>
<div id="references" class="section level1">
<h1>References</h1>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
